name: TFLint
run-name: TFLint
on:
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options:
        - dev
        - test
        - prod
        default: "dev"
      working_dir:
        type: string
        description: Working resource dir to run workflow from (eg- ec2)
        default: "ec2"

jobs:
  tflint:
    runs-on: ubuntu-latest
    name: Check terraform file are formatted correctly
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: git config
        run: |
          git config --global user.name $'{{ secrets.username }}' 
          git config --global user.email $'{{ secrets.email }}'

      - name: add git key
        env: 
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        run: |
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          ssh-add - <<< "${{ secrets.ssh }}"

      - name: Set Environment
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "dev" ]]; then
            echo "ENV=development" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.environment }}" == "test" ]]; then
            echo "ENV=staging" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ENV=production" >> $GITHUB_ENV
          else
            echo "ENV=development" >> $GITHUB_ENV
          fi

      - name: Construct Run Path
        run: echo "modules/$ENV/${{ github.event.inputs.working_dir}}"

      - name: modules/$ENV/${{ github.event.inputs.working_dir}}
        run: |
          cd modules/$ENV/${{ github.event.inputs.working_dir}}
      
      - name: terraform fmt
        uses: dflook/terraform-fmt@v1
        
      - name: Commit changes back to repo
        run: |
          git remote set-url origin ${{ secrets.ssh_url }}
          git status
          git add .
          git commit -m "$GITHUB_REF: Auto linting TF files"
          git fetch origin master
          git push origin HEAD:master