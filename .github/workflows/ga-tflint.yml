name: TFLint
run-name: TFLint
on:
  pull_request:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options:
        - dev
        - test
        - prod
        default: "dev"
      working_dir:
        type: string
        description: Working resource dir to run workflow from (eg- ec2)
        default: "ec2"

jobs:
  tflint:
    runs-on: ubuntu-latest
    name: Check terraform file are formatted correctly
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: git config
        run: |
          git config --global user.name $username
          git config --global user.email $email
        env:
          username: ${{ secrets.username }}
          email: ${{ secrets.email }}

      - name: add git key
        env: 
          ssh_auth_sock: /tmp/ssh_agent.sock
          ssh: ${{ secrets.ssh }}
        run: |
          ssh-agent -a $ssh_auth_sock > /dev/null
          ssh-add - <<< $ssh

      - name: Set Environment
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "dev" ]]; then
            echo "ENV=development" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.environment }}" == "test" ]]; then
            echo "ENV=staging" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "ENV=production" >> $GITHUB_ENV
          else
            echo "ENV=development" >> $GITHUB_ENV
          fi

      - name: Construct Run Path
        run: echo "modules/$ENV/${{ github.event.inputs.working_dir}}"

      - name: modules/$ENV/${{ github.event.inputs.working_dir}}
        run: |
          cd modules/$ENV/${{ github.event.inputs.working_dir}}
      
      - name: terraform fmt
        uses: dflook/terraform-fmt@v1
        
      - name: test git config
        run: git config -l
      - name: Commit changes back to repo
        run: git remote set-url origin $ssh_url
        env:
          ssh_url: ${{ secrets.ssh_url }}
      - name: git status
        run: git status
      - name: Stage Changes
        run: git add --all
      - name: Auto linting TF files
        run: git commit -m "Auto linting TF files"
      - name: Fetch origin
        run: git fetch origin master
      - name: push changes
        run: git push origin HEAD:master
